<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <style>

        head, body
        {
            width:100%;
            height:100%;
            margin:0;
            padding:0;
            overflow: hidden;
        }
        .instructions, .zoom
        {
            position: absolute;
            top:0;
            left:0;
            margin : 10px;
            padding : 10px;
            z-index: 10;
            background-color: white;
        }
        .instructions ul{ margin-left: -20px;}
        .zoom{
            left:auto;
            right:0;
        }
    </style>
</head>
<body>


<script src="../geom.js"></script>
<script src="../graphics.js"></script>

<!--utilitaires géométriques-->
<script src="utils/convexhull.js"></script>
<script src="utils/catmullrom.js"></script>
<script src="utils/paletteGenerator.js"></script>
<script src="CSVLoader.js"></script>
<script src="TXTLoader.js"></script>
<script src="light-map/light-map.js"></script>



<script>


    var w = window.innerWidth;
    var h = window.innerHeight;

    /**
     * liste de fonds de cartes
     * http://leaflet-extras.github.io/leaflet-providers/preview/index.html
     *
     * OSM: activité des trains
     * http://www.openrailwaymap.org/?lang=en&lat=48.8534100&lon=2.348800&zoom=11&style=standard
     */

//    var provider = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
//    var domains = 'abc'.split('');

//    var provider = 'http://otile{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.jpg';
//    var doamins = '1234'.split('');

    var provider = 'http://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png';
    var doamins = 'abcd'.split('');

    var map = new Map( provider, doamins, w,h, 1, 21 );

    var lat =  48.8534100;
    var lon =  2.348800;
    map.setView( lat, lon, 12 );

    document.body.appendChild( map.canvas );
    var colors = paletteGenerator.generate(100, 20);
    var G = new Graphics( map.ctx );
    var ctx = map.ctx;

    var coords = [2.224122,48.854199,2.224158,48.854615,2.224257,48.855241,2.224317,48.85555,2.224371,48.85581,2.224466,48.856232,2.224579,48.856632,2.224789,48.857329,2.224877,48.857605,2.225001,48.85798,2.225056,48.858124,2.225116,48.858268,2.22523,48.858519,2.225286,48.858627,2.22543,48.858914,2.225689,48.859437,2.225761,48.859727,2.226404,48.860958,2.226905,48.861793,2.227292,48.862573,2.227947,48.864333,2.228244,48.865145,2.228425,48.865429,2.228652,48.865766,2.229475,48.866727,2.229582,48.866847,2.23037,48.867734,2.231228,48.868624,2.23212,48.869553,2.232844,48.869755,2.237373,48.871013,2.239672,48.871576,2.240116,48.871717,2.240463,48.871888,2.241048,48.872277,2.24336,48.874127,2.245623,48.876364,2.247614,48.875871,2.249586,48.875376,2.254815,48.874081,2.255057,48.874153,2.255412,48.874264,2.258524,48.880086,2.258999,48.880267,2.260267,48.880106,2.264621,48.879566,2.27032,48.878856,2.270729,48.878805,2.27749,48.877963,2.278607,48.878298,2.278618,48.878301,2.279801,48.878653,2.279964,48.878702,2.280681,48.881838,2.280898,48.882795,2.280906,48.882878,2.281855,48.883622,2.284459,48.885638,2.285499,48.886445,2.285661,48.886571,2.286013,48.886743,2.286066,48.88677,2.286555,48.887009,2.28711,48.887283,2.287758,48.8876,2.28866,48.888042,2.289645,48.888525,2.290543,48.888966,2.291175,48.889275,2.291152,48.889297,2.291504,48.889459,2.291676,48.889479,2.292724,48.8896,2.294362,48.889789,2.295047,48.889869,2.295609,48.890161,2.29646,48.8906,2.297325,48.891056,2.298493,48.891692,2.300606,48.892673,2.303239,48.893898,2.303793,48.894171,2.306016,48.895227,2.307185,48.895784,2.307311,48.895847,2.307554,48.89596,2.307687,48.89601,2.30782,48.89606,2.309544,48.896708,2.312342,48.89776,2.313402,48.898072,2.315294,48.89865,2.316212,48.898927,2.318532,48.899633,2.318718,48.899744,2.31989,48.900459,2.320267,48.900697,2.320358,48.900757,2.321642,48.900838,2.322616,48.900857,2.322788,48.900861,2.324085,48.900886,2.327298,48.900908,2.327782,48.90099,2.330183,48.901028,2.334615,48.901136,2.33463,48.901136,2.334687,48.901137,2.334716,48.901138,2.334835,48.901141,2.335107,48.901148,2.335268,48.90115,2.335379,48.901153,2.335431,48.901154,2.335493,48.901155,2.335507,48.901155,2.335616,48.901158,2.335654,48.901158,2.335832,48.901162,2.336034,48.901167,2.336063,48.901168,2.336172,48.90117,2.336375,48.901175,2.336543,48.901178,2.336596,48.901179,2.336706,48.901182,2.336717,48.901182,2.336757,48.901183,2.336967,48.901188,2.337137,48.901193,2.337143,48.901193,2.337275,48.901197,2.34411,48.90133,2.348062,48.901414,2.351949,48.901492,2.351985,48.901493,2.3531,48.901507,2.355095,48.901532,2.357845,48.901609,2.358851,48.901624,2.361511,48.901679,2.361715,48.901683,2.361986,48.901688,2.365608,48.901763,2.370105,48.901854,2.370292,48.90186,2.371551,48.901886,2.375978,48.901981,2.379,48.902047,2.384429,48.902156,2.386186,48.901825,2.38724,48.901627,2.388704,48.901353,2.389426,48.901219,2.390661,48.900987,2.39374,48.899267,2.395527,48.898262,2.396027,48.897452,2.396441,48.896779,2.396929,48.895982,2.397727,48.894651,2.397762,48.894592,2.398046,48.893558,2.39808,48.893436,2.398119,48.893284,2.398286,48.892631,2.398624,48.891343,2.398762,48.890363,2.398959,48.889546,2.399171,48.888325,2.399187,48.888232,2.399191,48.887671,2.399192,48.887625,2.399192,48.88758,2.399194,48.887545,2.399202,48.886902,2.399203,48.886709,2.399204,48.886538,2.399205,48.886348,2.399206,48.886328,2.399206,48.88629,2.399207,48.886237,2.399205,48.885867,2.399206,48.88585,2.399225,48.885365,2.399239,48.884891,2.400073,48.883818,2.40046,48.883502,2.401467,48.882609,2.403792,48.881447,2.404609,48.881217,2.407182,48.88051,2.408306,48.880387,2.408376,48.88038,2.40929,48.880275,2.410836,48.878423,2.410856,48.878405,2.411856,48.877152,2.412485,48.876373,2.412838,48.875192,2.413138,48.874122,2.41338,48.873315,2.413429,48.87315,2.413567,48.872674,2.413624,48.872454,2.413703,48.871651,2.413785,48.870875,2.413821,48.870565,2.413954,48.869285,2.413965,48.867593,2.413912,48.865674,2.413894,48.865172,2.41386,48.864071,2.413902,48.863765,2.41396,48.863334,2.414059,48.862571,2.414295,48.861083,2.414494,48.859864,2.414624,48.859037,2.414712,48.858706,2.414851,48.857799,2.415167,48.855868,2.415267,48.855263,2.415281,48.85518,2.41534,48.854847,2.415427,48.854362,2.415461,48.854208,2.415524,48.853932,2.415599,48.853467,2.41571,48.852788,2.415809,48.852224,2.415882,48.851801,2.415973,48.851244,2.416015,48.850986,2.416038,48.850846,2.416198,48.84989,2.41636,48.849235,2.416437,48.848789,2.416408,48.848641,2.416403,48.848619,2.416391,48.848564,2.416356,48.848385,2.416304,48.848123,2.416295,48.848079,2.416262,48.847914,2.416256,48.847881,2.416201,48.847605,2.416193,48.847568,2.416184,48.847524,2.416177,48.847488,2.416159,48.847399,2.416156,48.847381,2.416138,48.847293,2.416119,48.847205,2.416071,48.846982,2.415993,48.846614,2.415867,48.84596,2.415859,48.845922,2.415809,48.845667,2.415792,48.845581,2.415793,48.845579,2.415765,48.845447,2.415747,48.84536,2.415723,48.845246,2.415693,48.845106,2.415313,48.843871,2.415306,48.843849,2.41525,48.843665,2.415209,48.84353,2.415181,48.843437,2.415178,48.843427,2.415142,48.84332,2.415106,48.843192,2.415075,48.843096,2.414957,48.842719,2.41489,48.842496,2.414491,48.841235,2.41435,48.840752,2.414313,48.840632,2.414286,48.840537,2.414257,48.840438,2.41425,48.840413,2.414066,48.839785,2.414051,48.839737,2.413979,48.839495,2.413957,48.839415,2.413934,48.839333,2.413928,48.839311,2.413905,48.839233,2.413898,48.839209,2.413888,48.839173,2.413859,48.839075,2.413848,48.83904,2.413816,48.838928,2.413804,48.83889,2.413792,48.838848,2.413782,48.838814,2.413719,48.838599,2.413641,48.838333,2.413597,48.838183,2.413543,48.837988,2.413533,48.837954,2.413513,48.837884,2.413372,48.83751,2.413347,48.837439,2.413309,48.837337,2.413142,48.836895,2.4131,48.836785,2.413036,48.836611,2.413022,48.836573,2.413002,48.836519,2.41298,48.836459,2.412959,48.8364,2.412924,48.836306,2.412858,48.836117,2.41282,48.836014,2.412786,48.835923,2.412774,48.835892,2.412488,48.835116,2.41241,48.834917,2.412276,48.834548,2.411926,48.834324,2.4114,48.833972,2.411321,48.833917,2.411227,48.833867,2.411427,48.833833,2.412794,48.833631,2.413125,48.833605,2.413426,48.833587,2.413653,48.833577,2.413906,48.833571,2.414139,48.833571,2.414369,48.833576,2.414622,48.833588,2.414883,48.833605,2.415122,48.833626,2.415362,48.833651,2.415608,48.833682,2.415861,48.833718,2.416111,48.833761,2.416344,48.833805,2.416637,48.833866,2.416886,48.833925,2.417116,48.833985,2.417332,48.834045,2.418869,48.834518,2.421602,48.835553,2.422108,48.83578,2.422176,48.835814,2.421697,48.836669,2.421638,48.83681,2.421563,48.837039,2.421531,48.83715,2.421424,48.837707,2.4213,48.838247,2.421223,48.838555,2.421074,48.839054,2.420992,48.839302,2.420856,48.839653,2.420725,48.839946,2.420604,48.840188,2.420418,48.840498,2.420384,48.840554,2.420269,48.840693,2.420034,48.840896,2.419858,48.841067,2.41957,48.841536,2.419424,48.842487,2.419537,48.842693,2.419578,48.842735,2.419635,48.842776,2.419711,48.842835,2.419773,48.842896,2.419825,48.842956,2.419873,48.843032,2.419904,48.843103,2.419915,48.843149,2.419921,48.843233,2.419918,48.843297,2.419905,48.843356,2.419882,48.843427,2.422106,48.844498,2.422344,48.844374,2.422455,48.844296,2.422574,48.8442,2.422758,48.844006,2.422858,48.843888,2.42294,48.843779,2.423066,48.843591,2.423193,48.843402,2.423478,48.842979,2.4237,48.842686,2.424062,48.842335,2.424567,48.841947,2.424816,48.8419,2.42476,48.84177,2.425045,48.841725,2.425091,48.84172,2.425575,48.84168,2.427563,48.841509,2.428268,48.841448,2.432446,48.841091,2.433638,48.840986,2.433679,48.841193,2.434139,48.841154,2.437192,48.840891,2.437273,48.841291,2.437534,48.842566,2.437553,48.842658,2.437899,48.844371,2.437941,48.844569,2.439384,48.844443,2.440512,48.844346,2.440577,48.844696,2.440593,48.844776,2.4406,48.844811,2.440608,48.844854,2.440616,48.844888,2.440809,48.844872,2.440874,48.84521,2.440695,48.845208,2.440766,48.845916,2.446526,48.84575,2.446553,48.845729,2.44641,48.844932,2.447732,48.844802,2.449392,48.844637,2.452202,48.844227,2.453673,48.844023,2.458065,48.843456,2.459699,48.843144,2.460839,48.842922,2.46113,48.842854,2.46174,48.842694,2.462206,48.842551,2.462733,48.842368,2.463265,48.842167,2.46384,48.841913,2.46423,48.841713,2.464555,48.841523,2.464994,48.841232,2.465287,48.841022,2.465663,48.840734,2.465936,48.840509,2.466378,48.840114,2.466541,48.839941,2.467232,48.839094,2.468457,48.837871,2.469305,48.83712,2.469417,48.837004,2.469505,48.836891,2.469698,48.83659,2.469722,48.836547,2.469746,48.836491,2.469758,48.836445,2.46976,48.836385,2.469703,48.835556,2.469627,48.835284,2.469489,48.834834,2.469389,48.834614,2.469296,48.834454,2.469178,48.834283,2.46905,48.834122,2.468937,48.833991,2.468758,48.833815,2.46859,48.833679,2.468375,48.833537,2.468125,48.833398,2.467689,48.833216,2.466727,48.832722,2.466427,48.832522,2.466088,48.832253,2.465897,48.832072,2.465721,48.831887,2.465491,48.831604,2.465361,48.831405,2.46523,48.831151,2.465105,48.830841,2.464983,48.830448,2.464642,48.829365,2.464514,48.82861,2.46455,48.827941,2.46461,48.827627,2.464903,48.827573,2.465087,48.82754,2.46523,48.82767,2.46543,48.82757,2.466178,48.827333,2.465761,48.826282,2.465695,48.826072,2.465359,48.825003,2.46512,48.824984,2.465247,48.824496,2.464717,48.823278,2.464666,48.823274,2.462906,48.820203,2.462639,48.819344,2.462523,48.819267,2.46281,48.819077,2.462803,48.819028,2.461308,48.818298,2.459755,48.81754,2.459197,48.817334,2.459249,48.817245,2.458633,48.817012,2.457215,48.817018,2.454549,48.817137,2.453317,48.817294,2.450826,48.817809,2.449638,48.817962,2.447613,48.818027,2.444983,48.81795,2.442673,48.817958,2.442159,48.817976,2.44165,48.818039,2.440014,48.818351,2.439864,48.818363,2.439751,48.818366,2.439592,48.818363,2.43735,48.818219,2.437387,48.818593,2.437425,48.818827,2.43747,48.819105,2.437361,48.819183,2.437253,48.819243,2.437088,48.819317,2.436968,48.819363,2.436763,48.81943,2.43646,48.819516,2.436266,48.81956,2.436109,48.819585,2.435964,48.8196,2.435165,48.81965,2.435135,48.819647,2.435077,48.819634,2.434933,48.819591,2.434819,48.819544,2.4345,48.819373,2.434323,48.819385,2.43418,48.819281,2.43427,48.819924,2.434302,48.820156,2.432474,48.82142,2.432889,48.82169,2.432624,48.821902,2.43219,48.821618,2.432153,48.821644,2.430372,48.82288,2.430549,48.823077,2.43062,48.823156,2.430691,48.823234,2.430239,48.823403,2.429751,48.823565,2.42925,48.823709,2.428947,48.823786,2.428375,48.823912,2.427833,48.824011,2.427152,48.824111,2.426501,48.824184,2.425957,48.824229,2.425651,48.824248,2.42495,48.824268,2.424475,48.82427,2.423978,48.824259,2.422873,48.824208,2.421781,48.824155,2.42081,48.824127,2.420354,48.824128,2.419946,48.824152,2.41987,48.824159,2.419533,48.824206,2.419036,48.824298,2.418679,48.824382,2.418074,48.824538,2.417628,48.82464,2.417215,48.82472,2.416708,48.824794,2.41639,48.824825,2.416073,48.824844,2.415661,48.824858,2.415156,48.824859,2.414625,48.824847,2.413848,48.824796,2.413193,48.824791,2.412617,48.824816,2.412298,48.824841,2.411836,48.824888,2.411292,48.824967,2.410804,48.825051,2.410518,48.825116,2.410256,48.825188,2.410244,48.825192,2.410048,48.825258,2.409904,48.825307,2.409622,48.825419,2.409244,48.825589,2.408771,48.825828,2.408308,48.826091,2.407706,48.826473,2.407283,48.826765,2.406516,48.82736,2.406228,48.827574,2.405453,48.828147,2.405195,48.828331,2.404918,48.828517,2.404584,48.828725,2.404267,48.828904,2.403919,48.82907,2.403663,48.829181,2.403082,48.829423,2.402488,48.829647,2.401494,48.829366,2.401477,48.829361,2.401306,48.82931,2.400996,48.829223,2.399774,48.828878,2.394352,48.827513,2.393214,48.827016,2.390949,48.826028,2.390256,48.825726,2.389778,48.82552,2.388812,48.825006,2.387171,48.824423,2.38515,48.823702,2.381513,48.822413,2.380745,48.821688,2.379059,48.821139,2.377859,48.820748,2.376025,48.820118,2.374154,48.819514,2.373905,48.819536,2.37086,48.818549,2.36696,48.817185,2.36519,48.816625,2.364731,48.816482,2.364276,48.816334,2.363408,48.816059,2.360246,48.816023,2.356613,48.815981,2.355917,48.815972,2.352399,48.818534,2.348548,48.816659,2.348494,48.816633,2.348361,48.816568,2.348189,48.816484,2.347977,48.81638,2.347787,48.816288,2.347389,48.816094,2.347192,48.815998,2.34692,48.815865,2.346622,48.815894,2.346427,48.815913,2.344432,48.816106,2.344497,48.815575,2.343974,48.815766,2.343705,48.815844,2.343054,48.816066,2.341667,48.816344,2.340293,48.816415,2.339531,48.816456,2.338669,48.816504,2.338022,48.816539,2.336763,48.816601,2.336051,48.816639,2.335141,48.816687,2.334941,48.816696,2.333724,48.816759,2.332116,48.816983,2.332048,48.816988,2.331957,48.816993,2.331899,48.816999,2.331733,48.817011,2.332093,48.817687,2.332371,48.818213,2.330814,48.818555,2.329272,48.818896,2.327455,48.819301,2.326917,48.819422,2.326872,48.819432,2.326801,48.819446,2.326663,48.819477,2.326629,48.819485,2.326548,48.819503,2.326326,48.819553,2.326272,48.819565,2.326119,48.8196,2.326093,48.819606,2.326086,48.819607,2.325938,48.819641,2.325596,48.819719,2.321317,48.820676,2.321159,48.820711,2.320871,48.820774,2.320635,48.820826,2.319836,48.821004,2.31679,48.821678,2.316618,48.821717,2.315136,48.822045,2.314731,48.822135,2.314554,48.822174,2.314542,48.822177,2.314415,48.822204,2.314363,48.822215,2.314153,48.82225,2.313391,48.822433,2.313386,48.822427,2.313014,48.822511,2.311524,48.822847,2.310258,48.823126,2.308423,48.823528,2.306812,48.823887,2.306502,48.823954,2.306346,48.823989,2.305836,48.824105,2.304122,48.824489,2.304004,48.82452,2.301779,48.825022,2.301318,48.825125,2.297647,48.825911,2.29423,48.82669,2.292221,48.827138,2.290903,48.827689,2.289388,48.828324,2.285469,48.829979,2.283363,48.830862,2.280491,48.831919,2.279023,48.832459,2.276328,48.830229,2.27576,48.829718,2.273396,48.828319,2.272727,48.827975,2.272308,48.827961,2.267837,48.827887,2.267605,48.827967,2.2673,48.831559,2.269672,48.832813,2.27003,48.833008,2.269951,48.833073,2.268878,48.833815,2.268332,48.8342,2.267809,48.834571,2.267469,48.834627,2.266925,48.834517,2.266178,48.834452,2.264916,48.834231,2.264369,48.834144,2.26296,48.833899,2.262776,48.833918,2.261646,48.834056,2.261166,48.834106,2.259466,48.834305,2.257458,48.834539,2.257108,48.834579,2.25684,48.834609,2.256169,48.834687,2.255154,48.834805,2.254195,48.83592,2.254088,48.836047,2.253935,48.836226,2.253783,48.836404,2.253728,48.836468,2.253301,48.836968,2.253211,48.837076,2.253014,48.83731,2.252305,48.838136,2.252298,48.838144,2.252219,48.838236,2.252086,48.838392,2.252055,48.838427,2.251929,48.838576,2.251649,48.838906,2.251607,48.839284,2.251594,48.839405,2.251568,48.839646,2.251542,48.839887,2.251529,48.840007,2.251495,48.840327,2.251406,48.841152,2.251324,48.841915,2.251309,48.842059,2.251272,48.842398,2.251219,48.842891,2.252538,48.84558,2.250956,48.845619,2.250892,48.845621,2.250845,48.845622,2.250676,48.845627,2.250544,48.845656,2.250423,48.845689,2.247958,48.846322,2.24556,48.846938,2.242466,48.847733,2.242452,48.847734,2.242445,48.847739,2.242437,48.847734,2.242414,48.847759,2.242421,48.847763,2.242413,48.84777,2.242416,48.847773,2.24241,48.847779,2.241595,48.84849,2.24031,48.8496,2.240118,48.849748,2.23995,48.849854,2.239697,48.849978,2.239558,48.850038,2.239324,48.850107,2.239084,48.85016,2.238144,48.850367,2.2378,48.85044,2.225495,48.85315,2.224169,48.853442,2.224161,48.853478,2.224143,48.853578,2.224135,48.853654,2.224129,48.853759,2.224125,48.853869,2.224125,48.85402,2.224122,48.854199];

    function draw()
    {
        requestAnimationFrame(draw);
        document.getElementsByClassName("zoom")[0].innerText = "zoom: "+ map.zoom;

        // redessine le fonds de carte
        ctx.globalAlpha = 1;
        map.renderTiles();

        //redessine le contour de Paris intramuros
        var border = [];
        for( var i = 0; i< coords.length; i+=2 )
        {
            var xy = map.latLonToPixels(coords[i+1], coords[i] );
            var np = new Point( xy[0], xy[1] );
            border.push( np );
        }
        ctx.globalCompositeOperation = "hard-light";
        ctx.fillStyle = ctx.strokeStyle = "hsl( 85, 50%, 50%)";
        ctx.lineWidth = map.zoom;
        ctx.lineJoin = "round";

        G.polyline( border, true );
        ctx.lineWidth = 1;

        //dessine les groupes de points
        groups.forEach( function( pos, i )
        {
            ctx.fillStyle = ctx.strokeStyle = colors[ (1+i) % colors.length ];

            pos.forEach( function( p )
            {
                var xy = map.latLonToPixels( p.x, p.y );
                G.disc( xy[0], xy[1], Math.max( 1, ( map.zoom - p.zoom ) ) * 5 );
            });

            var hull = convexhull.compute( pos ).map( lonLatToPixels );
            G.polygon( CatmullRom.compute( hull, .1, true ), true );

        });

        if( map.zoom >= 14 ) {

            ctx.beginPath();
            ctx.strokeStyle = "#F00";
            stations.forEach(function (station) {

                for (var i = 0; i < station.length - 1; i++) {
                    var p0 = map.latLonToPixels(station[i][1], station[i][0]);
                    if (p0[0] < 0 || p0[0] > w || p0[1] < 0 || p0[1] > h)continue;

                    var p1 = map.latLonToPixels(station[i + 1][1], station[i + 1][0]);
                    if (p1[0] < 0 || p1[0] > w || p1[1] < 0 || p1[1] > h)continue;

                    ctx.moveTo(p0[0], p0[1]);
                    ctx.lineTo(p1[0], p1[1]);
                }
            });
            ctx.stroke();

        }
        
        if( map.zoom >= 13 )
        {

            ctx.beginPath();
            ctx.strokeStyle = "#09C";
            ctx.globalCompositeOperation = "source-over";
            lines.forEach(function(line){

                for( var i = 0; i < line.length-1;i++ )
                {
                    var p0 = map.latLonToPixels( line[ i][1],      line[ i ][0] );
                    if( p0[0]<0 || p0[0]>w ||p0[1]<0 || p0[1]>h )continue;

                    var p1 = map.latLonToPixels( line[ i + 1][1],  line[ i + 1][0] );
                    if( p1[0]<0 || p1[0]>w ||p1[1]<0 || p1[1]>h )continue;

                    ctx.moveTo( p0[0], p0[1]);
                    ctx.lineTo( p1[0], p1[1]);
                }
            });
            ctx.stroke();

        }
    }

    function lonLatToPixels(p){
        var xy = map.latLonToPixels( p.x, p.y );

        //transformations spécifiques si besoin

        return new Point( xy[0], xy[1] );
    }

    var groups = [];
    var pos = [];

    var origin = new Point();
    var dest = new Point();
    var mouseDown = false;
    var ctrlDown = false;

    function onDown(e){

        origin.x = e.clientX;
        origin.y = e.clientY;
        mouseDown = true;

        if(  ctrlDown )
        {

            var cp = map.pixelsToLatLon( e.clientX, e.clientY );
            var p = new Point( cp[0], cp[1] );
            p.zoom = map.zoom;
            pos.push( p );

            if( groups.indexOf(pos)==-1)groups.push( pos );
        }
    }

    function onUp(e){
        mouseDown = false;
    }

    function onKeyHandler(e){
        ctrlDown = e.ctrlKey;
        if( ctrlDown == false )
        {
            if( pos.length != 0 )pos = [];
        }

        if(e.type=="keydown" && e.which == 32 )
        {
            new CSVLoader().load( "stations.csv", onStationsReady, ";" );
        }
    }

    function onMove(e){

        if( mouseDown ){

            dest.x = e.clientX;
            dest.y = e.clientY;

            var op = map.pixelsToLatLon( origin.x, origin.y );
            var dp = map.pixelsToLatLon( dest.x, dest.y );

            var lat = map.latitude + ( op[0] - dp[0] );
            var lon = map.longitude + ( op[1] - dp[1] );

            map.setView( lat, lon );

            origin.x = e.clientX;
            origin.y = e.clientY;

        }
    }

    function zoom(e){

        var x = e.clientX;
        var y = e.clientY;

        var op = map.pixelsToLatLon( x, y );
        map.zoom += e.wheelDelta > 0 ? 1 : -1;

        if( map.zoom != map.maxZoom ) {

            var dp = map.pixelsToLatLon(x, y);
            var lat = map.latitude + ( op[0] - dp[0] );
            var lon = map.longitude + ( op[1] - dp[1] );
            map.setView(lat, lon);

        }
        else
        {
            map.setView();
        }
    }

    function onResize()
    {
        w = window.innerWidth;
        h = window.innerHeight;
        map.width = w;
        map.height = h;
        map.setView();
    }
    window.addEventListener( "resize", onResize, false );

    map.canvas.addEventListener( "mousedown", onDown, false );
    map.canvas.addEventListener( "mouseup", onUp, false );
    map.canvas.addEventListener( "mouseleave", onUp, false );
    map.canvas.addEventListener( "mousewheel", zoom, false );
    map.canvas.addEventListener( "mousemove", onMove, false );

    window.addEventListener( "keydown", onKeyHandler, false );
    window.addEventListener( "keyup", onKeyHandler, false );


    //charge le CSV des gares et lignes de train

    var stations = [];
    function onStationsReady(result){

        result.forEach( function( o ){

            o.geoshape = JSON.parse( o.geoshape.replace( /^"/gi, "" ).replace( /"$/gi, "" ).replace( /""/gi, '"' ) );

            if(o.geoshape.type == "LineString" )stations.push( o.geoshape.coordinates );
            if( o.ligne ) o.ligne = o.ligne.split( ',' );

        });
    };
    var lines = [];
    var req = new XMLHttpRequest();
    req.onload = function( e ){

        var result = e.target.responseText.split( '\n' );
        result.forEach( function( o ){
            var cs = [];
            o.split(",").forEach( function(bit){

                var coords = bit.replace(/^\s\s*/, '').replace(/\s\s*$/, '').split( " " );
                cs.push( [parseFloat( coords[0] ),parseFloat( coords[1] )] );
            });
            lines.push( cs );
        });
//        console.log( result.length );
        console.log( lines[0] )
    };
    req.open( "GET", "railways.txt" );
    req.send();

    window.onload = draw;

</script>
<div class="instructions">
    <ul>
        <li>click / drag / molette pour explorer la carte</li>
        <li>CTRL + click, click, click pour dessiner des formes</li>
        <li>ESPACE pour charger/afficher les stations SNCF (Zoom 14+)</li>
    </ul>
</div>
<div class="zoom">12</div>
</body>
</html>