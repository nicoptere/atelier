<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <style>

        head, body
        {
            width:100%;
            height:100%;
            margin:0;
            padding:0;
            overflow: hidden;
        }

    </style>
</head>
<body>


<!--<script src="../base.js"></script>-->
<script src="../geom.js"></script>
<script src="../graphics.js"></script>
<script src="TXTLoader.js"></script>

<!--utilitaires géométriques-->
<script src="light-map/light-map.js"></script>



<script>

    var data = [];
    var w = window.innerWidth;
    var h = window.innerHeight;

//    var provider = "http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";
//    var domains = ["a","b","c"];

    var provider = 'http://otile{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.jpg';
    var domains = '1234'.split('');
    var map = new Map( provider, domains, w,h, 1, 19 );


    var lat =  48.8534100;
    var lon =  2.348800;
    map.setView( lat, lon, 16 );


    document.body.appendChild( map.canvas );
    var G = new Graphics( map.ctx );
    var ctx = map.ctx;

    function draw()
    {
        requestAnimationFrame(draw);

        w = window.innerWidth;
        h = window.innerHeight;
        map.width = w;
        map.height = h;
        map.setView();//redessine
        // ou :
        //map.renderTiles(); // si pas de changement de vue


        pos.forEach( function( p )
        {

            var xy = latLonToPixels( p[0], p[1] );
            G.disc( xy[0], xy[1], Math.max( 1, ( map.zoom - p[2] ) ) * 10 )

        });

    }

    var pos = [];
    var origin = new Point();
    var dest = new Point();
    var mouseDown = false;

    function onDown(e){

        var x = e.clientX;
        var y = e.clientY;
        origin.x = x;
        origin.y = y;
        mouseDown = true;

        var op = pixelsToLatLon( x, y );
        op.push( map.zoom );
        pos.push( op );

    }
    map.canvas.addEventListener( "mousedown", onDown, false );

    function onUp(e){
        mouseDown = false;
    }
    map.canvas.addEventListener( "mouseup", onUp, false );

    function onMove(e){

        if( mouseDown )
        {
            var x = e.clientX;
            var y = e.clientY;

            dest.x = x;
            dest.y = y;

            var op = pixelsToLatLon( origin.x, origin.y );
            var dp = pixelsToLatLon( dest.x, dest.y );

            var lat = map.latitude + ( op[0] - dp[0] );
            var lon = map.longitude + ( op[1] - dp[1] );

            map.setView( lat, lon );

            origin.x = x;
            origin.y = y;

        }
    }
    map.canvas.addEventListener( "mousemove", onMove, false );

    function zoom(e)
    {

        var x = e.clientX;
        var y = e.clientY;

        var op = pixelsToLatLon( x, y );

        map.zoom += e.wheelDelta > 0 ? 1 : -1;

        var dp = pixelsToLatLon( x, y );

        var lat = map.latitude + ( op[0] - dp[0] );
        var lon = map.longitude + ( op[1] - dp[1] );

        map.setView( lat, lon );

    }
    map.canvas.addEventListener( "mousewheel", zoom, false );

    function pixelsToLatLon( x,y, zoom )
    {

        var c = map.mercator.latLngToPixels( -map.latitude, map.longitude, zoom || map.zoom  );
        var pos = map.mercator.pixelsToLatLng( c[ 0 ] - map.width / 2 + x, c[ 1 ] - map.height / 2 + y, zoom || map.zoom );
        pos[0] *= -1;
        return pos;

    }

    function latLonToPixels( lat,lon, zoom )
    {

        var c = map.mercator.latLngToPixels( -map.latitude, map.longitude, zoom || map.zoom  );
        var p = map.mercator.latLngToPixels( -lat, lon, zoom || map.zoom  );
        return [ (p[0]-c[0]) + map.width / 2, ( p[1] - c[1] ) + map.height / 2 ];

    }

    draw();

</script>
</body>
</html>